<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mood Mirror - Create Viral Memes with Your Mood | Free Online Tool</title>
    <meta name="description" content="Create hilarious, personalized memes in seconds! Upload a photo, add up to 3 emojis and a caption, and share your mood with the world. 100% free, no sign-up needed.">
    <meta name="keywords" content="meme generator, create memes, funny memes, mood meme, viral meme, emoji meme, free meme maker, online meme tool, share meme, social media meme">
    <meta name="author" content="Mood Mirror">
    <meta name="robots" content="index, follow">
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Mood Mirror - Create Viral Memes with Your Mood">
    <meta property="og:description" content="Turn your selfie into a hilarious viral meme in seconds. Free, no sign-up, and loads of fun!">
    <meta property="og:image" content="https://yourdomain.com/preview-image.jpg">
    <meta property="og:url" content="https://yourdomain.com/">
    <meta property="og:type" content="website">
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mood Mirror - Create Viral Memes with Your Mood">
    <meta name="twitter:description" content="Turn your selfie into a hilarious viral meme in seconds. Free, no sign-up, and loads of fun!">
    <meta name="twitter:image" content="https://yourdomain.com/preview-image.jpg">
    <!-- Canonical URL -->
    <link rel="canonical" href="https://yourdomain.com/" />
    <!-- Preconnect to Google AdSense for faster ad loading -->
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mood Mirror",
      "description": "A free, browser-based tool to create funny, personalized memes by combining your photo with emojis and captions.",
      "applicationCategory": "EntertainmentApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #ff4e50;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            color: var(--dark);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            max-width: 300px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            max-width: 150px;
        }
        #cameraView, #editorView, #previewView, #emojiSelectionView {
            display: none;
            width: 100%;
        }
        #cameraVideo, #photoPreview, #finalMeme {
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 50vh;
            object-fit: contain;
        }
        /* Fix camera inversion */
        #cameraVideo {
            transform: scaleX(-1);
        }
        .emoji-tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        .emoji-tab {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-right: 10px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }
        .emoji-tab.active {
            background: var(--primary);
            color: white;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .emoji {
            font-size: 40px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            text-align: center;
            vertical-align: middle;
            line-height: 1.5;
        }
        .emoji:hover {
            background: #e9ecef;
            transform: scale(1.2);
        }
        .caption-select, .custom-caption {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ced4da;
            margin: 20px 0;
            font-size: 20px;
        }
        .meme-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
            min-height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .meme-image {
            width: 100%;
            border-radius: 10px;
            max-height: 400px;
            object-fit: contain;
        }
        .memoji-overlay {
            position: absolute;
            font-size: 80px;
            cursor: grab;
            user-select: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center;
        }
        .memoji-overlay:active {
            cursor: grabbing;
        }
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
            z-index: 20;
        }
        .category-title {
            margin-top: 20px;
            color: var(--primary);
            text-align: left;
            font-weight: bold;
        }
        .featured-memes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .meme-sample {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .meme-sample:hover {
            transform: scale(1.05);
        }
        .meme-sample img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .meme-sample p {
            padding: 10px;
            font-size: 14px;
            background: white;
            margin: 0;
        }
        .caption-area {
            margin: 20px 0;
            width: 100%;
        }
        .custom-caption {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ced4da;
            margin-top: 10px;
            font-size: 20px;
            display: none;
        }
        .ad-container {
            width: 100%;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ad-placeholder {
            color: #6c757d;
            font-size: 14px;
        }
        .emoji-counter {
            margin: 10px 0;
            font-weight: bold;
            color: var(--primary);
        }
        .selected-emojis {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .selected-emoji {
            font-size: 40px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }
        .remove-emoji {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .memoji-overlay {
                font-size: 15vw;
            }
            .caption-select, .custom-caption {
                font-size: 5vw;
            }
            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        @media (max-width: 480px) {
            .memoji-overlay {
                font-size: 18vw;
            }
            .caption-select, .custom-caption {
                font-size: 6vw;
            }
            .container {
                padding: 15px;
            }
            .featured-memes {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 2rem;
            }
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        .viral-share {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .share-btn {
            padding: 10px 15px;
            border-radius: 50px;
            background: #4267B2;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .share-btn.twitter {
            background: #1DA1F2;
        }
        .share-btn.whatsapp {
            background: #25D366;
        }
        .share-btn.tiktok {
            background: #000;
        }
        .trending-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="trending-badge">üî• Trending</div>
        
        <h1>Mood Mirror</h1>
        <p class="subtitle">Create Viral Memes with Your Mood</p>

        <!-- Home View -->
        <div id="homeView">
            <button class="btn" onclick="showCamera()">Create Your Mood Meme</button>
            <p>OR</p>
            <button class="btn" onclick="uploadPhoto()">Choose from Gallery</button>
            
            <div class="viral-share">
                <button class="share-btn" onclick="shareApp('facebook')">üì± Share</button>
                <button class="share-btn twitter" onclick="shareApp('twitter')">üê¶ Tweet</button>
                <button class="share-btn whatsapp" onclick="shareApp('whatsapp')">üí¨ WhatsApp</button>
            </div>
            
            <div class="category-title">Trending Memes</div>
            <div class="featured-memes" id="featuredMemes">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="ad-container">
                <div class="ad-placeholder">Sponsored Content üî•</div>
            </div>
        </div>

        <!-- Camera View -->
        <div id="cameraView">
            <video id="cameraVideo" autoplay playsinline></video>
            <button class="btn" onclick="capturePhoto()">Capture Photo</button>
            <button class="btn btn-secondary" onclick="showHome()">Cancel</button>
        </div>

        <!-- Editor View -->
        <div id="editorView">
            <div class="meme-container" id="memeContainer">
                <img id="photoPreview" alt="Your photo" class="meme-image">
                <!-- Emoji overlays will be added here dynamically -->
            </div>
            
            <div class="selected-emojis" id="selectedEmojisList">
                <!-- Selected emojis will be displayed here -->
            </div>
            
            <button class="btn" id="addEmojiButton" onclick="showEmojiSelection()">Add Emojis (0/3)</button>
            
            <div class="caption-area">
                <p>Choose a Caption:</p>
                <select class="caption-select" id="captionSelect" onchange="handleCaptionChange()">
                    <option value="">Select a caption...</option>
                    <!-- Will be populated by JavaScript -->
                </select>
                <p>OR</p>
                <input type="text" class="custom-caption" id="customCaption" placeholder="Type your own caption...">
            </div>
            
            <button class="btn" onclick="generateMeme()">Preview Your Masterpiece!</button>
            <button class="btn btn-secondary" onclick="showHome()">Start Over</button>
            
            <div class="ad-container">
                <div class="ad-placeholder">Your Ad Here üöÄ</div>
            </div>
        </div>

        <!-- Emoji Selection View -->
        <div id="emojiSelectionView">
            <h2>Select Emojis</h2>
            <p class="emoji-counter" id="emojiCounter">Selected: 0/3</p>
            
            <div class="emoji-tabs" id="emojiTabs">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="emoji-grid" id="emojiGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="btn" onclick="confirmEmojiSelection()">Confirm Selection</button>
            <button class="btn btn-secondary" onclick="cancelEmojiSelection()">Cancel</button>
        </div>

        <!-- Preview View -->
        <div id="previewView">
            <img id="finalMeme" alt="Your mood meme" class="meme-image">
            
            <div class="viral-share">
                <button class="share-btn" onclick="shareMeme('facebook')">üì± Share</button>
                <button class="share-btn twitter" onclick="shareMeme('twitter')">üê¶ Tweet</button>
                <button class="share-btn whatsapp" onclick="shareMeme('whatsapp')">üí¨ WhatsApp</button>
                <button class="share-btn tiktok" onclick="shareMeme('tiktok')">üéµ TikTok</button>
            </div>
            
            <button class="btn" onclick="downloadMeme()">Download Meme</button>
            <button class="btn btn-secondary" onclick="startOver()">Create Another</button>
        </div>
    </div>

    <script>
        // State variables
        let selectedEmojis = [];
        let userPhotoData = null;
        let currentEmojiCategory = 'smileys';
        let selectedCaption = '';
        let isPremium = true; // Premium features enabled for all users
        let editorContainerWidth = 0;
        let isResizing = false;
        let activeEmojiIndex = -1;

        // Elements
        const homeView = document.getElementById('homeView');
        const cameraView = document.getElementById('cameraView');
        const editorView = document.getElementById('editorView');
        const previewView = document.getElementById('previewView');
        const emojiSelectionView = document.getElementById('emojiSelectionView');
        const cameraVideo = document.getElementById('cameraVideo');
        const photoPreview = document.getElementById('photoPreview');
        const finalMeme = document.getElementById('finalMeme');
        const emojiTabs = document.getElementById('emojiTabs');
        const emojiGrid = document.getElementById('emojiGrid');
        const captionSelect = document.getElementById('captionSelect');
        const customCaption = document.getElementById('customCaption');
        const featuredMemes = document.getElementById('featuredMemes');
        const memeContainer = document.getElementById('memeContainer');
        const selectedEmojisList = document.getElementById('selectedEmojisList');
        const emojiCounter = document.getElementById('emojiCounter');
        const addEmojiButton = document.getElementById('addEmojiButton');

        // All emojis organized by category
        const emojiCategories = {
            smileys: ["üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "üòÇ", "ü§£", "üòä", "üòá", "üôÇ", "üôÉ", "üòâ", "üòå", "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ", "üòù", "üòú", "ü§™", "ü§®", "üßê", "ü§ì", "üòé", "ü§©", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï", "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©", "ü•∫", "üò¢", "üò≠", "üò§", "üò†", "üò°", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞", "üò•", "üòì", "ü´£", "ü§ó", "ü´°", "ü§î", "ü´¢", "ü§≠", "ü§´", "ü§•", "üò∂", "ü´†", "üòê", "ü´§", "üòë", "üò¨", "üôÑ", "üòØ", "üò¶", "üòß", "üòÆ", "üò≤", "ü•±", "üò¥", "ü§§", "üò™", "üòµ", "ü•¥", "ü§ê", "ü•≤", "ü§¢", "ü§ß", "üò∑", "ü§í", "ü§ï"],
            animals: ["üêµ", "üêí", "ü¶ç", "ü¶ß", "üê∂", "üêï", "ü¶Æ", "üêï‚Äçü¶∫", "üê©", "üê∫", "ü¶ä", "ü¶ù", "üê±", "üêà", "üêà‚Äç‚¨õ", "ü¶Å", "üêØ", "üêÖ", "üêÜ", "üê¥", "üêé", "ü¶Ñ", "ü¶ì", "ü¶å", "ü¶¨", "üêÆ", "üêÇ", "üêÉ", "üêÑ", "üê∑", "üêñ", "üêó", "üêΩ", "üêè", "üêë", "üêê", "üê™", "üê´", "ü¶ô", "ü¶í", "üêò", "ü¶£", "ü¶è", "ü¶õ", "üê≠", "üêÅ", "üêÄ", "üêπ", "üê∞", "üêá", "üêøÔ∏è", "ü¶´", "ü¶î", "ü¶á", "üêª", "üêª‚Äç‚ùÑÔ∏è", "üê®", "üêº", "ü¶•", "ü¶¶", "ü¶®", "ü¶ò", "ü¶°", "üêæ", "ü¶É", "üêî", "üêì", "üê£", "üê§", "üê•", "üê¶", "üêß", "üïäÔ∏è", "ü¶Ö", "ü¶Ü", "ü¶¢", "ü¶â", "ü¶§", "ü™∂", "ü¶©", "ü¶ú", "üê∏", "üêä", "üê¢", "ü¶é", "üêç", "üê≤", "üêâ", "ü¶ï", "ü¶ñ", "üê≥", "üêã", "üê¨", "ü¶≠", "üêü", "üê†", "üê°", "ü¶à", "üêô", "üêö", "üêå", "ü¶ã", "üêõ", "üêú", "üêù", "ü™≤", "üêû", "ü¶ó", "ü™≥", "üï∑Ô∏è", "üï∏Ô∏è", "ü¶Ç", "ü¶ü", "ü™∞", "ü™±"],
            nature: ["üíê", "üå∏", "üíÆ", "üèµÔ∏è", "üåπ", "ü•Ä", "üå∫", "üåª", "üåº", "üå∑", "üå±", "ü™¥", "üå≤", "üå≥", "üå¥", "üåµ", "üåæ", "üåø", "‚òòÔ∏è", "üçÄ", "üçÅ", "üçÇ", "üçÉ", "ü™π", "ü™∫", "üçÑ", "üçá", "üçà", "üçâ", "üçä", "üçã", "üçå", "üçç", "ü•≠", "üçé", "üçè", "üçê", "üçë", "üçí", "üçì", "ü´ê", "ü•ù", "üçÖ", "ü´í", "ü••", "ü•ë", "üçÜ", "ü•î", "ü•ï", "üåΩ", "üå∂Ô∏è", "ü´ë", "ü•í", "ü•¨", "ü•¶", "üßÑ", "üßÖ", "üçÑ", "ü•ú", "üå∞", "ü´ò", "üçû", "ü•ê", "ü•ñ", "ü´ì", "ü•®", "ü•Ø", "ü•û", "üßá", "üßÄ", "üçñ", "üçó", "ü•©", "ü•ì", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü´î", "ü•ô", "üßÜ", "ü•ö", "üç≥", "ü•ò", "üç≤", "ü´ï", "ü•£", "ü•ó", "üçø", "üßà", "üßÇ", "ü•´", "üçù", "üç±", "üçò", "üçô", "üçö", "üçõ", "üçú", "üç†", "üç¢", "üç£", "üç§", "üç•", "ü•Æ", "üç°", "ü•ü", "ü•†", "ü•°", "üç¶", "üçß", "üç®", "üç©", "üç™", "üéÇ", "üç∞", "üßÅ", "ü•ß", "üç´", "üç¨", "üç≠", "üçÆ", "üçØ", "üçº", "ü•õ", "‚òï", "ü´ñ", "üçµ", "üç∂", "üçæ", "üç∑", "üç∏", "üçπ", "üç∫", "üçª", "ü•Ç", "ü•É", "ü´ó", "ü•§", "üßã", "üßÉ", "üßâ", "üßä"],
            symbols: ["‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî", "‚ù§Ô∏è‚Äçüî•", "‚ù§Ô∏è‚Äçü©π", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è", "‚úùÔ∏è", "‚ò™Ô∏è", "üïâÔ∏è", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê", "‚õé", "‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê", "‚ôë", "‚ôí", "‚ôì", "üÜî", "‚öõÔ∏è", "üâë", "‚ò¢Ô∏è", "‚ò£Ô∏è", "üì¥", "üì≥", "üà∂", "üàö", "üà∏", "üà∫", "üà∑Ô∏è", "‚ú¥Ô∏è", "üÜö", "üíÆ", "üâê", "„äôÔ∏è", "„äóÔ∏è", "üà¥", "üàµ", "üàπ", "üà≤", "üÖ∞Ô∏è", "üÖ±Ô∏è", "üÜé", "üÜë", "üÖæÔ∏è", "üÜò", "‚ùå", "‚≠ï", "üõë", "‚õî", "üìõ", "üö´", "üíØ", "üí¢", "‚ô®Ô∏è", "üö∑", "üöØ", "üö≥", "üö±", "üîû", "üìµ", "üö≠", "‚ùó", "‚ùï", "‚ùì", "‚ùî", "‚ÄºÔ∏è", "‚ÅâÔ∏è", "üîÖ", "üîÜ", "„ÄΩÔ∏è", "‚ö†Ô∏è", "üö∏", "üî±", "‚öúÔ∏è", "üî∞", "‚ôªÔ∏è", "‚úÖ", "üàØ", "üíπ", "‚ùáÔ∏è", "‚ú≥Ô∏è", "‚ùé", "üåê", "üí†", "‚ìÇÔ∏è", "üåÄ", "üí§", "üèß", "üöæ", "‚ôø", "üÖøÔ∏è", "üõó", "üà≥", "üàÇÔ∏è", "üõÇ", "üõÉ", "üõÑ", "üõÖ", "üöπ", "üö∫", "üöº", "‚ößÔ∏è", "üöª", "üöÆ", "üé¶", "üì∂", "üàÅ", "üî£", "üî§", "üî°", "üî†", "üÜñ", "üÜó", "üÜô", "üÜí", "üÜï", "üÜì", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü", "üî¢", "#Ô∏è‚É£", "*Ô∏è‚É£", "‚èèÔ∏è", "‚ñ∂Ô∏è", "‚è∏Ô∏è", "‚èØÔ∏è", "‚èπÔ∏è", "‚è∫Ô∏è", "‚è≠Ô∏è", "‚èÆÔ∏è", "‚è©", "‚è™", "‚è´", "‚è¨", "‚óÄÔ∏è", "üîº", "üîΩ", "‚û°Ô∏è", "‚¨ÖÔ∏è", "‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚ÜóÔ∏è", "‚ÜòÔ∏è", "‚ÜôÔ∏è", "‚ÜñÔ∏è", "‚ÜïÔ∏è", "‚ÜîÔ∏è", "‚Ü™Ô∏è", "‚Ü©Ô∏è", "‚§¥Ô∏è", "‚§µÔ∏è", "üîÄ", "üîÅ", "üîÇ", "üîÑ", "üîÉ", "üéµ", "üé∂", "‚ûï", "‚ûñ", "‚ûó", "‚ôæÔ∏è", "üí≤", "üí±", "‚Ñ¢Ô∏è", "¬©Ô∏è", "¬ÆÔ∏è", "„Ä∞Ô∏è", "‚û∞", "‚ûø", "üîö", "üîô", "üîõ", "üîù", "üîú"]
        };

        // Premium emojis (now available to all users)
        const premiumEmojis = ["üöÄ", "üåü", "üéØ", "üî•", "üíé", "ü¶Ñ", "üëë", "ü§ñ", "üé®", "‚ö°", "üí´", "‚ú®", "üé≠", "üé™", "üé¢", "üé°", "üèÜ", "ü•á", "ü•à", "ü•â", "üèÖ", "üéñÔ∏è", "üèµÔ∏è", "üéóÔ∏è", "üéÅ", "üéâ", "üéä", "üéà", "üíå", "üíò", "üíù", "üíñ", "üíó", "üíì", "üíû", "üíï", "üíü", "‚ù£Ô∏è", "üíî", "‚ù§Ô∏è‚Äçüî•", "‚ù§Ô∏è‚Äçü©π", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíã", "üëÑ", "üëÖ", "üëÇ", "üëÉ", "üëÅÔ∏è", "üëÄ", "üß†", "ü¶¥", "ü¶∑", "ü¶¥", "üíÄ", "üëª", "üëΩ", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "üòΩ", "üôÄ", "üòø", "üòæ"];

        // All meme captions organized by category
        const memeCaptions = {
            mood: [
                "My Monday brain trying to function...",
                "Me remembering that thing I said 5 years ago.",
                "My wallet after the weekend:",
                "My serotonin levels right now.",
                "My will to live on a Monday.",
                "It's 8 AM. I'm already done.",
                "My brain cells after that meeting.",
                "Wait, it's already Friday?",
                "When someone says 'We need to talk'.",
                "My reaction to your opinion.",
                "I have several questions.",
                "Me pretending to listen.",
                "My bank account.",
                "My motivation.",
                "This week lasting 84 years.",
                "My main character energy today.",
                "My confidence vs. my skills.",
                "Me, an intellectual.",
                "My mental health.",
                "My brain on caffeine.",
                "My willpower avoiding snacks.",
                "My social battery right now.",
                "My productivity level.",
                "My last two brain cells.",
                "My patience running out.",
                "My soul leaving my body during small talk.",
                "My energy after one social interaction."
            ],
            relatable: [
                "When you finally understand the assignment.",
                "When the WiFi connects automatically.",
                "When you find money in your old jeans.",
                "When the teacher says 'no homework'.",
                "When you avoid someone you know in public.",
                "When you send a text and immediately regret it.",
                "When you're the last one to get the joke.",
                "When you try to be cool in front of your crush.",
                "When your parents are proud of you.",
                "When you remember embarrassing childhood memories.",
                "When you're home alone and hear a noise.",
                "When you successfully parallel park on first try.",
                "When you pretend to work when boss walks by.",
                "When you're watching a movie and recognize an actor.",
                "When you try to sneak food into the movie theater.",
                "When you're singing in the car and make eye contact.",
                "When you're trying to be quiet but everything is loud.",
                "When you see your ex looking better than you.",
                "When you're about to sneeze but it goes away.",
                "When you're telling a story and no one is listening."
            ],
            popCulture: [
                "That's what she said. - Michael Scott",
                "Why are you the way that you are? - Michael Scott",
                "I'm not superstitious, but I am a little stitious. - Michael Scott",
                "How the turntables... - Michael Scott",
                "You miss 100% of the shots you don't take. - Wayne Gretzky - Michael Scott",
                "I'm ready to get hurt again. - Michael Scott",
                "I'm not a hero. I'm a high-functioning sociopath. - Sherlock",
                "Winter is coming. - Game of Thrones",
                "You know nothing, Jon Snow. - Game of Thrones",
                "This is the way. - The Mandalorian",
                "I have a bad feeling about this. - Star Wars",
                "May the force be with you. - Star Wars"
            ],
            funny: [
                "This is fine. Everything is fine.",
                "Wait, that's illegal.",
                "Ah yes, the floor here is made of floor.",
                "They had us in the first half, not gonna lie.",
                "Is this a pigeon?",
                "I've never been so offended by something I 100% agree with.",
                "But that's none of my business.",
                "That's a bold strategy, Cotton. Let's see if it pays off.",
                "Cool story, bro.",
                "You had one job.",
                "I don't know what I expected.",
                "Well, well, well, how the turntables...",
                "I've made a huge mistake.",
                "There's always money in the banana stand.",
                "Her?",
                "It's an illusion, Michael.",
                "I don't understand the question, and I won't respond to it."
            ]
        };

        // Premium captions (now available to all users)
        const premiumCaptions = [
            "When you're the main character but forgot your lines",
            "My brain during small talk: üé™ü§π‚Äç‚ôÇÔ∏èüé≠",
            "Me trying to adult: ü§°üåç",
            "My productivity: üìâüìâüìâ",
            "My social skills: ü¶îüé§",
            "My confidence: üöÄüåï | My skills: üêåüõå",
            "Me pretending to work: üé≠üíºü§´",
            "My bank account: üï≥Ô∏èüëÄüåÄ",
            "My mental health: üé¢üå™Ô∏èüé≠"
        ];

        // Initialize the app
        function initApp() {
            // Add premium emojis to the symbols category for all users
            emojiCategories.symbols = [...emojiCategories.symbols, ...premiumEmojis];
            
            populateEmojiTabs();
            showEmojiCategory('smileys');
            populateCaptionDropdown();
            populateFeaturedMemes();
            updateAddEmojiButton();
        }

        // Populate emoji tabs
        function populateEmojiTabs() {
            emojiTabs.innerHTML = '';
            
            for (const category in emojiCategories) {
                const tab = document.createElement('div');
                tab.className = 'emoji-tab';
                tab.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                tab.onclick = () => showEmojiCategory(category);
                emojiTabs.appendChild(tab);
            }
            
            // Activate the first tab
            if (emojiTabs.firstChild) {
                emojiTabs.firstChild.classList.add('active');
            }
        }

        // Show emojis for a specific category
        function showEmojiCategory(category) {
            // Update active tab
            const tabs = emojiTabs.getElementsByClassName('emoji-tab');
            for (const tab of tabs) {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(category)) {
                    tab.classList.add('active');
                }
            }
            
            // Clear the grid
            emojiGrid.innerHTML = '';
            
            // Add emojis to grid
            emojiCategories[category].forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji';
                emojiElement.textContent = emoji;
                emojiElement.onclick = () => addEmojiToSelection(emoji);
                emojiGrid.appendChild(emojiElement);
            });
            
            currentEmojiCategory = category;
        }

        // Add emoji to selection
        function addEmojiToSelection(emoji) {
            if (selectedEmojis.length >= 3) {
                alert('Maximum of 3 emojis reached. Remove one to add another.');
                return;
            }
            
            // Add emoji with default position
            selectedEmojis.push({
                emoji: emoji,
                x: 30 + (selectedEmojis.length * 20),
                y: 30 + (selectedEmojis.length * 10),
                fontSize: 80 // Default font size for emojis
            });
            
            updateEmojiCounter();
            renderSelectedEmojisList();
            renderEmojiOverlays();
        }

        // Remove emoji from selection
        function removeEmojiFromSelection(index) {
            selectedEmojis.splice(index, 1);
            updateEmojiCounter();
            renderSelectedEmojisList();
            renderEmojiOverlays();
        }

        // Update emoji counter
        function updateEmojiCounter() {
            emojiCounter.textContent = `Selected: ${selectedEmojis.length}/3`;
            updateAddEmojiButton();
        }

        // Update the Add Emoji button text
        function updateAddEmojiButton() {
            if (addEmojiButton) {
                addEmojiButton.textContent = `Add Emojis (${selectedEmojis.length}/3)`;
            }
        }

        // Render selected emojis list
        function renderSelectedEmojisList() {
            selectedEmojisList.innerHTML = '';
            
            selectedEmojis.forEach((emojiObj, index) => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'selected-emoji';
                emojiElement.textContent = emojiObj.emoji;
                
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-emoji';
                removeButton.textContent = '√ó';
                removeButton.onclick = (e) => {
                    e.stopPropagation();
                    removeEmojiFromSelection(index);
                };
                
                emojiElement.appendChild(removeButton);
                selectedEmojisList.appendChild(emojiElement);
            });
        }

        // Populate caption dropdown
        function populateCaptionDropdown() {
            captionSelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a caption...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            captionSelect.appendChild(defaultOption);
            
            // Add custom caption option
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Write my own caption...';
            captionSelect.appendChild(customOption);
            
            // Add options from all categories
            for (const category in memeCaptions) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = category.charAt(0).toUpperCase() + category.slice(1) + ' Captions';
                
                memeCaptions[category].forEach(caption => {
                    const option = document.createElement('option');
                    option.value = caption;
                    option.textContent = caption;
                    optGroup.appendChild(option);
                });
                
                captionSelect.appendChild(optGroup);
            }
            
            // Add premium captions (now available to all)
            const premiumOptGroup = document.createElement('optgroup');
            premiumOptGroup.label = '‚≠ê Premium Captions';
            
            premiumCaptions.forEach(caption => {
                const option = document.createElement('option');
                option.value = caption;
                option.textContent = caption;
                premiumOptGroup.appendChild(option);
            });
            
            captionSelect.appendChild(premiumOptGroup);
        }

        // Handle caption change
        function handleCaptionChange() {
            const selectedValue = captionSelect.value;
            
            if (selectedValue === 'custom') {
                customCaption.style.display = 'block';
                customCaption.value = '';
                selectedCaption = '';
            } else {
                customCaption.style.display = 'none';
                selectedCaption = selectedValue;
            }
        }

        // Populate featured memes on home screen
        function populateFeaturedMemes() {
            // Create some sample featured memes
            const samples = [
                { caption: "My Monday mood", emoji: "üò¥" },
                { caption: "When the code works", emoji: "üéâ" },
                { caption: "My social battery", emoji: "üîã" },
                { caption: "My brain on caffeine", emoji: "‚ö°" }
            ];
            
            samples.forEach(sample => {
                const memeElement = document.createElement('div');
                memeElement.className = 'meme-sample';
                
                // Create a canvas to generate the sample image
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Draw background
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw text
                ctx.font = '20px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(sample.caption, canvas.width / 2, 50);
                
                // Draw emoji
                ctx.font = '80px Arial';
                ctx.fillText(sample.emoji, canvas.width / 2, canvas.height / 2);
                
                // Create image from canvas
                const dataUrl = canvas.toDataURL('image/png');
                
                memeElement.innerHTML = `
                    <img src="${dataUrl}" alt="${sample.caption}">
                    <p>${sample.caption}</p>
                `;
                
                memeElement.onclick = () => {
                    selectedEmojis = [{ emoji: sample.emoji, x: 50, y: 30, fontSize: 80 }];
                    uploadPhoto();
                };
                
                featuredMemes.appendChild(memeElement);
            });
        }

        // Show home view
        function showHome() {
            homeView.style.display = 'block';
            cameraView.style.display = 'none';
            editorView.style.display = 'none';
            previewView.style.display = 'none';
            emojiSelectionView.style.display = 'none';
            
            // Stop camera if it's running
            if (cameraVideo.srcObject) {
                cameraVideo.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // Show camera view
        function showCamera() {
            homeView.style.display = 'none';
            cameraView.style.display = 'block';
            
            // Access camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
            .then(stream => {
                cameraVideo.srcObject = stream;
            })
            .catch(error => {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please check permissions.');
                showHome();
            });
        }

        // Upload photo from gallery
        function uploadPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        // Create image to check dimensions and resize if needed
                        const img = new Image();
                        img.onload = function() {
                            const maxWidth = 800;
                            const maxHeight = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round(height * maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round(width * maxHeight / height);
                                    height = maxHeight;
                                }
                            }
                            
                            // Create canvas to resize image
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Use resized image
                            userPhotoData = canvas.toDataURL('image/jpeg', 0.8);
                            photoPreview.src = userPhotoData;
                            
                            homeView.style.display = 'none';
                            editorView.style.display = 'block';
                            
                            // Store container width for size calculations
                            editorContainerWidth = memeContainer.offsetWidth;
                            
                            // Render emoji overlays
                            renderEmojiOverlays();
                            
                            // Adjust font sizes after image loads
                            setTimeout(adjustFontSizes, 100);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Adjust font sizes based on container
        function adjustFontSizes() {
            const container = document.querySelector('.meme-container');
            if (!container) return;
            
            const containerWidth = container.offsetWidth;
            
            // Adjust emoji size based on container
            const emojiSize = Math.min(100, Math.max(40, containerWidth / 6));
            document.querySelectorAll('.memoji-overlay').forEach(overlay => {
                overlay.style.fontSize = `${emojiSize}px`;
            });
            
            // Adjust caption size
            const captionSize = Math.min(20, Math.max(14, containerWidth / 25));
            document.querySelectorAll('.caption-select, .custom-caption').forEach(el => {
                el.style.fontSize = `${captionSize}px`;
            });
        }

        // Render emoji overlays
        function renderEmojiOverlays() {
            // Clear existing overlays
            document.querySelectorAll('.memoji-overlay').forEach(el => el.remove());
            
            // Create overlays for each emoji
            selectedEmojis.forEach((emojiObj, index) => {
                const overlay = document.createElement('div');
                overlay.className = 'memoji-overlay';
                overlay.textContent = emojiObj.emoji;
                overlay.style.left = `${emojiObj.x}%`;
                overlay.style.top = `${emojiObj.y}%`;
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.fontSize = `${emojiObj.fontSize}px`;
                
                // Create resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                
                // Make draggable and resizable
                makeDraggable(overlay, index);
                makeResizable(overlay, resizeHandle, index);
                
                overlay.appendChild(resizeHandle);
                memeContainer.appendChild(overlay);
            });
            
            adjustFontSizes();
        }

        // Make emoji draggable
        function makeDraggable(element, index) {
            let isDragging = false;
            let offset = { x: 0, y: 0 };

            element.addEventListener('mousedown', e => {
                // Only drag if not resizing and not clicking on resize handle
                if (!isResizing && e.target !== element.querySelector('.resize-handle')) {
                    isDragging = true;
                    const rect = element.getBoundingClientRect();
                    // Calculate offset from center of element
                    offset.x = e.clientX - (rect.left + rect.width / 2);
                    offset.y = e.clientY - (rect.top + rect.height / 2);
                    element.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', e => {
                if (isDragging && !isResizing) {
                    const containerRect = memeContainer.getBoundingClientRect();
                    // Calculate center position
                    let centerX = e.clientX - containerRect.left - offset.x;
                    let centerY = e.clientY - containerRect.top - offset.y;
                    
                    // Convert to percentages
                    const percentX = (centerX / containerRect.width) * 100;
                    const percentY = (centerY / containerRect.height) * 100;
                    
                    // Keep within bounds
                    const emojiWidthPercent = (element.offsetWidth / containerRect.width) * 100;
                    const emojiHeightPercent = (element.offsetHeight / containerRect.height) * 100;
                    
                    const boundedX = Math.max(emojiWidthPercent/2, Math.min(percentX, 100 - emojiWidthPercent/2));
                    const boundedY = Math.max(emojiHeightPercent/2, Math.min(percentY, 100 - emojiHeightPercent/2));
                    
                    element.style.left = `${boundedX}%`;
                    element.style.top = `${boundedY}%`;
                    
                    // Update position in state
                    selectedEmojis[index].x = boundedX;
                    selectedEmojis[index].y = boundedY;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });

            // Touch events for mobile
            element.addEventListener('touchstart', e => {
                if (!isResizing && e.target !== element.querySelector('.resize-handle')) {
                    isDragging = true;
                    const rect = element.getBoundingClientRect();
                    offset.x = e.touches[0].clientX - (rect.left + rect.width / 2);
                    offset.y = e.touches[0].clientY - (rect.top + rect.height / 2);
                    e.preventDefault();
                }
            });

            document.addEventListener('touchmove', e => {
                if (isDragging && !isResizing) {
                    const containerRect = memeContainer.getBoundingClientRect();
                    let centerX = e.touches[0].clientX - containerRect.left - offset.x;
                    let centerY = e.touches[0].clientY - containerRect.top - offset.y;
                    
                    // Convert to percentages
                    const percentX = (centerX / containerRect.width) * 100;
                    const percentY = (centerY / containerRect.height) * 100;
                    
                    // Keep within bounds
                    const emojiWidthPercent = (element.offsetWidth / containerRect.width) * 100;
                    const emojiHeightPercent = (element.offsetHeight / containerRect.height) * 100;
                    
                    const boundedX = Math.max(emojiWidthPercent/2, Math.min(percentX, 100 - emojiWidthPercent/2));
                    const boundedY = Math.max(emojiHeightPercent/2, Math.min(percentY, 100 - emojiHeightPercent/2));
                    
                    element.style.left = `${boundedX}%`;
                    element.style.top = `${boundedY}%`;
                    
                    // Update position in state
                    selectedEmojis[index].x = boundedX;
                    selectedEmojis[index].y = boundedY;
                    
                    e.preventDefault();
                }
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        // Make emoji resizable
        function makeResizable(element, handle, index) {
            let startSize, startX, startY;

            handle.addEventListener('mousedown', e => {
                isResizing = true;
                activeEmojiIndex = index;
                startSize = parseInt(getComputedStyle(element).fontSize);
                startX = e.clientX;
                startY = e.clientY;
                e.stopPropagation();
            });

            document.addEventListener('mousemove', e => {
                if (isResizing && activeEmojiIndex === index) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // Calculate new size based on mouse movement
                    const delta = Math.sqrt(deltaX * deltaX + deltaY * deltaY) * (deltaX + deltaY > 0 ? 1 : -1);
                    const newSize = Math.max(20, Math.min(200, startSize + delta));
                    
                    // Update size
                    element.style.fontSize = `${newSize}px`;
                    selectedEmojis[index].fontSize = newSize;
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                activeEmojiIndex = -1;
            });

            // Touch events for mobile
            handle.addEventListener('touchstart', e => {
                isResizing = true;
                activeEmojiIndex = index;
                startSize = parseInt(getComputedStyle(element).fontSize);
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                e.stopPropagation();
            });

            document.addEventListener('touchmove', e => {
                if (isResizing && activeEmojiIndex === index) {
                    const deltaX = e.touches[0].clientX - startX;
                    const deltaY = e.touches[0].clientY - startY;
                    
                    // Calculate new size based on touch movement
                    const delta = Math.sqrt(deltaX * deltaX + deltaY * deltaY) * (deltaX + deltaY > 0 ? 1 : -1);
                    const newSize = Math.max(20, Math.min(200, startSize + delta));
                    
                    // Update size
                    element.style.fontSize = `${newSize}px`;
                    selectedEmojis[index].fontSize = newSize;
                    
                    e.preventDefault();
                }
            });

            document.addEventListener('touchend', () => {
                isResizing = false;
                activeEmojiIndex = -1;
            });
        }

        // Capture photo from camera - FIXED (no longer inverted)
        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Fix camera inversion by flipping the canvas back
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            userPhotoData = canvas.toDataURL('image/png');
            photoPreview.src = userPhotoData;
            
            // Stop camera stream
            cameraVideo.srcObject.getTracks().forEach(track => track.stop());
            
            cameraView.style.display = 'none';
            editorView.style.display = 'block';
            
            // Store container width for size calculations
            editorContainerWidth = memeContainer.offsetWidth;
            
            // Render emoji overlays
            renderEmojiOverlays();
            
            // Adjust font sizes
            setTimeout(adjustFontSizes, 100);
        }

        // Show emoji selection view
        function showEmojiSelection() {
            editorView.style.display = 'none';
            emojiSelectionView.style.display = 'block';
            updateEmojiCounter();
        }

        // Confirm emoji selection and return to editor
        function confirmEmojiSelection() {
            emojiSelectionView.style.display = 'none';
            editorView.style.display = 'block';
            renderEmojiOverlays();
        }

        // Cancel emoji selection
        function cancelEmojiSelection() {
            emojiSelectionView.style.display = 'none';
            editorView.style.display = 'block';
        }

        // Generate final meme
        function generateMeme() {
            // Get the selected caption
            if (captionSelect.value === 'custom') {
                selectedCaption = customCaption.value.trim();
            } else {
                selectedCaption = captionSelect.value;
            }
            
            // If no caption is selected, use a default one
            if (!selectedCaption) {
                selectedCaption = "Mood Mirror Meme";
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Use the natural image dimensions for highest quality
                const width = img.naturalWidth;
                const height = img.naturalHeight;
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw user photo
                ctx.drawImage(img, 0, 0, width, height);
                
                // Calculate scaling factor between displayed image and actual image
                const previewRect = photoPreview.getBoundingClientRect();
                const imageRect = photoPreview.getBoundingClientRect();
                
                // Calculate scale factors
                const scaleX = width / imageRect.width;
                const scaleY = height / imageRect.height;
                
                // Draw all emojis
                selectedEmojis.forEach(emojiObj => {
                    // Calculate position based on percentages
                    const x = (emojiObj.x / 100) * width;
                    const y = (emojiObj.y / 100) * height;
                    
                    // Calculate scaled size - use the same scale factor for both dimensions
                    const scaledEmojiSize = emojiObj.fontSize * scaleX;
                    
                    // Add emoji
                    ctx.font = `bold ${scaledEmojiSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(emojiObj.emoji, x, y);
                });
                
                // Add caption with better text wrapping
                const captionFontSize = Math.max(24, Math.min(48, width / 20));
                ctx.font = `bold ${captionFontSize}px Arial`;
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = Math.max(3, captionFontSize / 8);
                ctx.textAlign = 'center';
                
                // Simple text wrapping
                const maxTextWidth = width * 0.9;
                const lines = [];
                let line = '';
                const words = selectedCaption.split(' ');
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxTextWidth && i > 0) {
                        lines.push(line);
                        line = words[i] + ' ';
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line);
                
                // Draw text lines
                const lineHeight = captionFontSize * 1.4;
                const textY = height - (lines.length * lineHeight) - 30;
                
                lines.forEach((line, index) => {
                    const y = textY + (index * lineHeight);
                    ctx.strokeText(line, width / 2, y);
                    ctx.fillText(line, width / 2, y);
                });
                
                // Set final meme
                finalMeme.src = canvas.toDataURL('image/png');
                
                editorView.style.display = 'none';
                previewView.style.display = 'block';
            };
            
            img.src = userPhotoData;
        }

        // Download meme
        function downloadMeme() {
            const link = document.createElement('a');
            link.download = 'mood-mirror-meme.png';
            link.href = finalMeme.src;
            link.click();
        }

        // Share meme
        function shareMeme(platform) {
            if (navigator.share) {
                navigator.share({
                    title: 'My Mood Mirror Meme',
                    text: 'Check out this meme I made with Mood Mirror!',
                    url: window.location.href,
                })
                .catch(error => {
                    console.error('Error sharing:', error);
                    alert(`Shared to ${platform}! In a real app, this would share directly.`);
                });
            } else {
                alert(`Shared to ${platform}! In a real app, this would share directly.`);
            }
        }

        // Share app
        function shareApp(platform) {
            alert(`Shared Mood Mirror on ${platform}! In a real app, this would share directly.`);
        }

        // Start over
        function startOver() {
            previewView.style.display = 'none';
            homeView.style.display = 'block';
            selectedEmojis = [];
            userPhotoData = null;
            selectedCaption = '';
            captionSelect.value = '';
            customCaption.value = '';
            customCaption.style.display = 'none';
            
            // Clear emoji overlays
            document.querySelectorAll('.memoji-overlay').forEach(el => el.remove());
            
            // Update UI
            updateEmojiCounter();
            renderSelectedEmojisList();
        }

        // Initialize the app when the page loads
        window.onload = initApp;
    </script>
</body>
</html>