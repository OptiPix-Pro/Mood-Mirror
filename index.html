
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mood Mirror - Create Viral Memes with Your Mood | Free Online Tool</title>
    <meta name="description" content="Create hilarious, personalized memes in seconds! Upload a photo, add up to 3 emojis and a caption, and share your mood with the world. 100% free, no sign-up needed.">
    <meta name="keywords" content="meme generator, create memes, funny memes, mood meme, viral meme, emoji meme, free meme maker, online meme tool, share meme, social media meme">
    <meta name="author" content="Mood Mirror">
    <meta name="google-site-verification" content="9fOwJUM_DTiIYgQMQHeK5o1DRKXWr1l_DbYwAuZap48" />
    <meta name="robots" content="index, follow">
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Mood Mirror - Create Viral Memes with Your Mood">
    <meta property="og:description" content="Turn your selfie into a hilarious viral meme in seconds. Free, no sign-up, and loads of fun!">
    <meta property="og:image" content="https://mood-mirror-xdwq.onrender.com/preview-image.jpg">
    <meta property="og:url" content="https://mood-mirror-xdwq.onrender.com/">
    <meta property="og:type" content="website">
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mood Mirror - Create Viral Memes with Your Mood">
    <meta name="twitter:description" content="Turn your selfie into a hilarious viral meme in seconds. Free, no sign-up, and loads of fun!">
    <meta name="twitter:image" content="https://mood-mirror-xdwq.onrender.com/preview-image.jpg">
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mood-mirror-xdwq.onrender.com/" />
    <!-- Preconnect to Google AdSense for faster ad loading -->
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Lobster&display=swap" rel="stylesheet">
    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2629754813976130" crossorigin="anonymous"></script>
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mood Mirror",
      "description": "A free, browser-based tool to create funny, personalized memes by combining your photo with emojis and captions.",
      "applicationCategory": "EntertainmentApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #ff4e50;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --container-bg: white;
            --text-color: #333;
            --box-shadow-color: rgba(0,0,0,0.1);
            --input-border-color: #ced4da;
        }
        
        body.dark-mode {
            --primary: #8A2BE2; /* A brighter purple for dark mode */
            --secondary: #4169E1; /* A brighter blue */
            --light: #2a2a38; /* Becomes dark bg for elements */
            --dark: #f0f0f0; /* Becomes light text */
            --background: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --box-shadow-color: rgba(0,0,0,0.5);
            --input-border-color: #555;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--box-shadow-color);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        h1 {
            color: var(--primary);
            margin-bottom: 0;
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            color: var(--dark);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
            width: 100%;
            max-width: 300px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            max-width: 150px;
        }
        #cameraView, #editorView, #previewView, #emojiSelectionView {
            display: none;
            width: 100%;
        }
        #cameraVideo, #photoPreview, #finalMeme {
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px var(--box-shadow-color);
            max-height: 50vh;
            object-fit: contain;
        }
        /* Fix camera inversion */
        #cameraVideo {
            transform: scaleX(-1);
        }
        .emoji-tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        .emoji-tab {
            padding: 10px 15px;
            background: var(--light);
            color: var(--text-color);
            border-radius: 10px;
            margin-right: 10px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.3s;
        }
        .emoji-tab.active {
            background: var(--primary);
            color: white;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
        }
        .emoji {
            font-size: 40px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            background: var(--container-bg);
            transition: all 0.3s;
            text-align: center;
            vertical-align: middle;
            line-height: 1.5;
        }
        .emoji:hover {
            background: #e9ecef;
            transform: scale(1.2);
        }
        body.dark-mode .emoji:hover {
            background: #333;
        }
        .caption-select, .custom-caption, .font-select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--input-border-color);
            margin: 10px 0;
            font-size: 20px;
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        .meme-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
            min-height: 300px;
            background: var(--light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .meme-image {
            width: 100%;
            border-radius: 10px;
            max-height: 400px;
            object-fit: contain;
        }
        .memoji-overlay {
            position: absolute;
            font-family: Arial, sans-serif; /* Unify font with canvas render */
            font-size: 80px;
            cursor: grab;
            user-select: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center;
        }
        .memoji-overlay:active {
            cursor: grabbing;
        }
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
            z-index: 20;
        }
        .category-title {
            margin-top: 20px;
            color: var(--primary);
            text-align: left;
            font-weight: bold;
        }
        .featured-memes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .meme-sample {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px var(--box-shadow-color);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .meme-sample:hover {
            transform: scale(1.05);
        }
        .meme-sample img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .meme-sample p {
            padding: 10px;
            font-size: 14px;
            background: var(--container-bg);
            color: var(--text-color);
            margin: 0;
        }
        .caption-area {
            margin: 20px 0;
            width: 100%;
        }
        .custom-caption {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--input-border-color);
            margin-top: 10px;
            font-size: 20px;
            display: none;
        }
        .font-select option.impact { font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif; }
        .font-select option.arial-black { font-family: 'Arial Black', Gadget, sans-serif; }
        .font-select option.comic-sans { font-family: 'Comic Sans MS', cursive, sans-serif; }
        .font-select option.courier-new { font-family: 'Courier New', Courier, monospace; }
        .font-select option.lobster { font-family: 'Lobster', cursive; }
        .font-select option.anton { font-family: 'Anton', sans-serif; }
        #homeAdContainer, #editorAdContainer {
            width: 100%;
            margin: 20px 0;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            text-align: center;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ad-placeholder {
            color: #6c757d;
            font-size: 14px;
        }
        .emoji-counter {
            margin: 10px 0;
            font-weight: bold;
            color: var(--primary);
        }
        .selected-emojis {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .selected-emoji {
            font-size: 40px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            position: relative;
        }
        .remove-emoji {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .caption-style-container {
            margin-top: 20px;
        }
        .caption-bg-swatches {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .caption-bg-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--input-border-color);
            transition: border-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .caption-bg-swatch:hover {
            transform: scale(1.1);
        }
        .caption-bg-swatch.selected {
            border-color: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        @media (max-width: 768px) {
            .memoji-overlay {
                font-size: 15vw;
            }
            .caption-select, .custom-caption, .font-select {
                font-size: 5vw;
            }
            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        @media (max-width: 480px) {
            .memoji-overlay {
                font-size: 18vw;
            }
            .caption-select, .custom-caption, .font-select {
                font-size: 6vw;
            }
            .container {
                padding: 15px;
            }
            .featured-memes {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 2rem;
            }
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        .viral-share {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .share-btn {
            padding: 10px 15px;
            border-radius: 50px;
            background: #4267B2;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .share-btn.twitter {
            background: #1DA1F2;
        }
        .share-btn.whatsapp {
            background: #25D366;
        }
        .share-btn.tiktok {
            background: #000;
        }
        .support-us-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(to right, #ffafbd, #ffc3a0);
            color: #4A4A4A;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 10;
        }
        .support-us-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        /* New styles for sharing feedback */
        .share-feedback {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
        }
        .share-success {
            background-color: #d4edda;
            color: #155724;
        }
        .share-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        body.dark-mode .share-success {
            background-color: #1c3b23;
            color: #d4edda;
        }
        body.dark-mode .share-error {
            background-color: #491217;
            color: #f8d7da;
        }
        /* Styles for Cookie Consent Banner */
        .cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(52, 58, 64, 0.9);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 15px;
        }
        .cookie-consent-banner p {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        .cookie-consent-banner a {
            color: #2575fc;
            text-decoration: underline;
        }
        .cookie-consent-banner .btn {
            margin: 0;
            width: auto;
            flex-shrink: 0;
        }
        /* Theme Switcher Styles */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <script>
        // Immediately invoked function to set the theme on initial load
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>
    <div class="container">
        <a href="/contact.html" class="support-us-badge">Support Us ❤️</a>
        
        <div class="header-container">
            <h1>Mood Mirror</h1>
            <label class="theme-switch" for="theme-toggle" title="Toggle dark mode">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
        </div>
        <p class="subtitle">Create Viral Memes with Your Mood</p>

        <!-- Home View -->
        <div id="homeView">
            <button class="btn" onclick="showCamera()">Create Your Mood Meme</button>
            <p>OR</p>
            <button class="btn" onclick="uploadPhoto()">Choose from Gallery</button>

            <div class="viral-share">
                <button class="share-btn" onclick="shareApp('facebook')">📱 Share</button>
                <button class="share-btn twitter" onclick="shareApp('twitter')">🐦 Tweet</button>
                <button class="share-btn whatsapp" onclick="shareApp('whatsapp')">💬 WhatsApp</button>
            </div>
            
            <div class="category-title">Trending Memes</div>
            <div class="featured-memes" id="featuredMemes">
                <!-- Will be populated by JavaScript -->
            </div>
            <!-- Ad container placeholder -->
            <div id="homeAdContainer"></div>
        </div>

        <!-- Camera View -->
        <div id="cameraView">
            <video id="cameraVideo" autoplay playsinline></video>
            <button id="captureBtn" class="btn" onclick="capturePhoto()" disabled>Capture Photo</button>
            <button class="btn btn-secondary" onclick="showHome()">Cancel</button>
        </div>

        <!-- Editor View -->
        <div id="editorView">
            <div class="meme-container" id="memeContainer">
                <img id="photoPreview" alt="Your photo" class="meme-image">
                <!-- Emoji overlays will be added here dynamically -->
            </div>
            
            <div class="selected-emojis" id="selectedEmojisList">
                <!-- Selected emojis will be displayed here -->
            </div>
            
            <button class="btn" id="addEmojiButton" onclick="showEmojiSelection()">Add Emojis (0/3)</button>
            
            <div class="caption-area">
                <label for="captionSelect" style="display: block; text-align: left; margin-bottom: 10px;">Choose a Caption:</label>
                <select class="caption-select" id="captionSelect" onchange="handleCaptionChange()">
                    <option value="">Select a caption...</option>
                    <!-- Will be populated by JavaScript -->
                </select>
                <p>OR</p>
                <input type="text" class="custom-caption" id="customCaption" placeholder="Type your own caption...">

                <label for="fontSelect" style="display: block; text-align: left; margin-top: 20px; margin-bottom: 10px;">Choose a Font:</label>
                <select class="font-select" id="fontSelect" onchange="handleFontChange()">
                  <option value="Impact" class="impact">Impact</option>
                  <option value="Arial Black" class="arial-black">Arial Black</option>
                  <option value="Comic Sans MS" class="comic-sans">Comic Sans MS</option>
                  <option value="Courier New" class="courier-new" selected>Courier New</option>
                  <option value="Lobster" class="lobster">Lobster</option>
                  <option value="Anton" class="anton">Anton</option>
                </select>

                <div class="caption-style-container">
                    <label style="display: block; text-align: left; margin-bottom: 10px;">Caption Style:</label>
                    <div class="caption-bg-swatches" id="captionBgSwatches">
                        <!-- Swatches will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="generateMeme()">Preview Your Masterpiece!</button>
            <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
            
            <div id="editorAdContainer"></div>
        </div>

        <!-- Emoji Selection View -->
        <div id="emojiSelectionView">
            <h2>Select Emojis</h2>
            <p class="emoji-counter" id="emojiCounter">Selected: 0/3</p>
            
            <div class="emoji-tabs" id="emojiTabs">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="emoji-grid" id="emojiGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="btn" onclick="confirmEmojiSelection()">Confirm Selection</button>
            <button class="btn btn-secondary" onclick="cancelEmojiSelection()">Cancel</button>
        </div>

        <!-- Preview View -->
        <div id="previewView">
            <!-- Added container for consistent sizing -->
            <div class="meme-container">
                <img id="finalMeme" alt="Your mood meme" class="meme-image">
            </div>
            
            <div class="viral-share">
                <button class="share-btn" onclick="shareMeme('facebook')">📱 Share</button>
                <button class="share-btn twitter" onclick="shareMeme('twitter')">🐦 Tweet</button>
                <button class="share-btn whatsapp" onclick="shareMeme('whatsapp')">💬 WhatsApp</button>
                <button class="share-btn tiktok" onclick="shareMeme('tiktok')">🎵 TikTok</button>
            </div>
            
            <div id="shareFeedback" class="share-feedback" style="display: none;"></div>
            
            <button class="btn" onclick="downloadMeme()">Download Meme</button>
            <button class="btn btn-secondary" onclick="startOver()">Create Another</button>
        </div>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookieConsentBanner" class="cookie-consent-banner" style="display: none;">
        <p>We use cookies to personalize ads and improve your experience. See our <a href="/privacy-policy.html">Privacy Policy</a> for more details.</p>
        <div>
            <button id="acceptCookies" class="btn btn-small">Accept</button>
            <button id="declineCookies" class="btn btn-small btn-secondary">Decline</button>
        </div>
    </div>
    
    <script>
        // State variables
        let selectedEmojis = [];
        let userPhotoData = null;
        let currentEmojiCategory = 'smileys';
        let selectedCaption = '';
        let selectedFont = 'Courier New';
        let selectedCaptionBackground = 'none';
        let editorContainerWidth = 0;
        
        // State for drag/resize/pinch interactions
        let isResizing = false;
        let isDragging = false;
        let activeEmojiIndex = -1;
        let dragOffset = { x: 0, y: 0 };
        let resizeStart = { size: 0, x: 0, y: 0 };
        
        // Variables for swipe gestures
        let touchstartX = 0;
        let touchendX = 0;
        let touchstartY = 0;
        let touchendY = 0;
        const swipeThreshold = 50; // Min distance for a swipe to be registered
        // Store the final meme data URL for sharing
        let finalMemeDataURL = null;
        // Ad observer
        let adObserver = null;

        // Elements
        const homeView = document.getElementById('homeView');
        const cameraView = document.getElementById('cameraView');
        const editorView = document.getElementById('editorView');
        const previewView = document.getElementById('previewView');
        const emojiSelectionView = document.getElementById('emojiSelectionView');
        const cameraVideo = document.getElementById('cameraVideo');
        const photoPreview = document.getElementById('photoPreview');
        const finalMeme = document.getElementById('finalMeme');
        const emojiTabs = document.getElementById('emojiTabs');
        const emojiGrid = document.getElementById('emojiGrid');
        const captionSelect = document.getElementById('captionSelect');
        const customCaption = document.getElementById('customCaption');
        const fontSelect = document.getElementById('fontSelect');
        const featuredMemes = document.getElementById('featuredMemes');
        const memeContainer = document.getElementById('memeContainer');
        const selectedEmojisList = document.getElementById('selectedEmojisList');
        const emojiCounter = document.getElementById('emojiCounter');
        const addEmojiButton = document.getElementById('addEmojiButton');
        const shareFeedback = document.getElementById('shareFeedback');
        const captureBtn = document.getElementById('captureBtn');
        const themeToggle = document.getElementById('theme-toggle');
        const captionBgSwatches = document.getElementById('captionBgSwatches');

        // All emojis organized by category
        const emojiCategories = {
            smileys: ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩", "🥳", "😏", "😒", "😞", "😔", "😟", "😕", "🙁", "☹️", "😣", "😖", "😫", "😩", "🥺", "😢", "😭", "😤", "😠", "😡", "😳", "🥵", "🥶", "😱", "😨", "😰", "😥", "😓", "🫣", "🤗", "🫡", "🤔", "🫢", "🤭", "🤫", "🤥", "😶", "🫠", "😐", "🫤", "😑", "😬", "🙄", "😯", "😦", "😧", "😮", "😲", "🥱", "😴", "🤤", "😪", "😵", "🥴", "🤐", "🥲", "🤢", "🤧", "😷", "🤒", "🤕", "🫨", "🫸", "🫷", "🙂‍↔️", "🙂‍↕️"],
            animals: ["🐵", "🐒", "🦍", "🦧", "🐶", "🐕", "🦮", "🐕‍🦺", "🐩", "🐺", "🦊", "🦝", "🐱", "🐈", "🐈‍⬛", "🦁", "🐯", "🐅", "🐆", "🐴", "🐎", "🦄", "🦓", "🦌", "🦬", "🐮", "🐂", "🐃", "🐄", "🐷", "🐖", "🐗", "🐽", "🐏", "🐑", "🐐", "🐪", "🐫", "🦙", "🦒", "🐘", "🦣", "🦏", "🦛", "🐭", "🐁", "🐀", "🐹", "🐰", "🐇", "🐿️", "🦫", "🦔", "🦇", "🐻", "🐻‍❄️", "🐨", "🐼", "🦥", "🦦", "🦨", "🦘", "🦡", "🐾", "🦃", "🐔", "🐓", "🐣", "🐤", "🐥", "🐦", "🐧", "🕊️", "🦅", "🦆", "🦢", "🦉", "🦤", "🪶", "🦩", "🦜", "🐸", "🐊", "🐢", "🦎", "🐍", "🐲", "🐉", "🦕", "🦖", "🐳", "🐋", "🐬", "🦭", "🐟", "🐠", "🐡", "🦈", "🐙", "🐚", "🐌", "🦋", "🐛", "🐜", "🐝", "🪲", "🐞", "🦗", "🪳", "🕷️", "🕸️", "🦂", "🦟", "🪰", "🪱", "𫎭", "𫎯", "🪽", "🪿", "🪼", "🐦‍🔥"],
            food: ["🍇", "🍈", "🍉", "🍊", "🍋", "🍌", "🍍", "🥭", "🍎", "🍏", "🍐", "🍑", "🍒", "🍓", "🫐", "🥝", "🍅", "🥥", "🥑", "🍆", "🥔", "🥕", "🌽", "🌶️", "🫑", "🥒", "🥬", "🥦", "🧄", "🧅", "🥜", "🌰", "🍞", "🥐", "🥖", "🥨", "🥯", "🥞", "🧇", "🧀", "🍖", "🍗", "🥩", "🥓", "🍔", "🍟", "🍕", "🌭", "🥪", "🌮", "🌯", "🥙", "🧆", "🥚", "🍳", "🥘", "🍲", "🥣", "🥗", "🍿", "🧈", "🧂", "🥫", "🍱", "🍘", "🍙", "🍚", "🍛", "🍜", "🍝", "🍠", "🍢", "🍣", "🍤", "🍥", "🥮", "🍡", "🥟", "🥠", "🥡", "🍦", "🍧", "🍨", "🍩", "🍪", "🎂", "🍰", "🧁", "🥧", "🍫", "🍬", "🍭", "🍮", "🍯", "🍼", "🥛", "☕", "🍵", "🍶", "🍾", "🍷", "🍸", "🍹", "🍺", "🍻", "🥂", "🥃", "🥤", "🧋", "🧃", "🧉", "🧊", "🫛", "🫚", "🍋‍🟩"],
            nature: ["💐", "🌸", "💮", "🏵️", "🌹", "🥀", "🌺", "🌻", "🌼", "🌷", "🌱", "🪴", "🌲", "🌳", "🌴", "🌵", "🌾", "🌿", "☘️", "🍀", "🍁", "🍂", "🍃", "🍄", "🪹", "🪺", "🪻", "🍄‍🟫", "🌍", "🌎", "🌏", "🌋", "🏔️", "⛰️", "🏞️", "🏜️", "🏝️", "🌅", "🌄", "☀️", "🌤️", "⛅", "🌥️", "☁️", "🌦️", "🌧️", "⛈️", "🌩️", "⚡", "🔥", "💥", "❄️", "🌨️", "☃️", "⛄", "🌬️", "💨", "💧", "💦", "🌊", "⭐", "🌟", "💫", "✨", "🌙", "☄️", "🪐", "🌑", "🌒", "🌓", "🌔", "🌕", "🌖", "🌗", "🌘", "🌀", "🌈"],
            symbols: ["❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔", "❤️‍🔥", "❤️‍🩹", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💟", "☮️", "✝️", "☪️", "🕉️", "☸️", "✡️", "🔯", "🕎", "☯️", "☦️", "🛐", "⛎", "♈", "♉", "♊", "♋", "♌", "♍", "♎", "♏", "♐", "♑", "♒", "♓", "🆔", "⚛️", "🉑", "☢️", "☣️", "📴", "📳", "🈶", "🈚", "🈸", "🈺", "🈷️", "✴️", "🆚", "💮", "🉐", "㊙️", "㊗️", "🈴", "🈵", "🈹", "🈲", "🅰️", "🅱️", "🆎", "🆑", "🅾️", "🆘", "❌", "⭕", "🛑", "⛔", "📛", "🚫", "💯", "💢", "♨️", "🚷", "🚯", "🚳", "🚱", "🔞", "📵", "🚭", "❗", "❕", "❓", "❔", "‼️", "⁉️", "🔅", "🔆", "〽️", "⚠️", "🚸", "🔱", "⚜️", "🔰", "♻️", "✅", "🈯", "💹", "❇️", "✳️", "❎", "🌐", "💠", "Ⓜ️", "🌀", "💤", "🏧", "🚾", "♿", "🅿️", "🛗", "🈳", "🈂️", "🛂", "🛃", "🛄", "🛅", "🚹", "🚺", "🚼", "⚧️", "🚻", "🚮", "🎦", "📶", "🈁", "🔣", "🔤", "🔡", "🔠", "🆖", "🆗", "🆙", "🆒", "🆕", "🆓", "0️⃣", "1️⃣", "2️⃣", "3️⃣", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣", "9️⃣", "🔟", "🔢", "#️⃣", "*️⃣", "⏏️", "▶️", "⏸️", "⏯️", "⏹️", "⏺️", "⏭️", "⏮️", "⏩", "⏪", "⏫", "⏬", "◀️", "🔼", "🔽", "➡️", "⬅️", "⬆️", "⬇️", "↗️", "↘️", "↙️", "↖️", "↕️", "↔️", "↪️", "↩️", "⤴️", "⤵️", "🔀", "🔁", "🔂", "🔄", "🔃", "🎵", "🎶", "➕", "➖", "➗", "♾️", "💲", "💱", "™️", "©️", "®️", "〰️", "➰", "➿", "🔚", "🔙", "🔛", "🔝", "🔜", "🩷", "🩵", "🩶", "☬", "🛜", "⛓️‍💥", "🪭", "🪮", "🪇", "🪈"]
        };

        // Premium emojis (now available to all users)
        const premiumEmojis = ["🚀", "🌟", "🎯", "🔥", "💎", "🦄", "👑", "🤖", "🎨", "⚡", "💫", "✨", "🎭", "🎪", "🎢", "🎡", "🏆", "🥇", "🥈", "🥉", "🏅", "🎖️", "🏵️", "🎗️", "🎁", "🎉", "🎊", "🎈", "💌", "💘", "💝", "💖", "💗", "💓", "💞", "💕", "💟", "❣️", "💔", "❤️‍🔥", "❤️‍🩹", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💋", "👄", "👅", "👂", "👃", "👁️", "👀", "🧠", "🦴", "🦷", "🦴", "💀", "👻", "👽", "😺", "😸", "😹", "😻", "😼", "😽", "🙀", "😿", "😾"];

        // All meme captions organized by category
        const memeCaptions = {
            mood: [
                "My Monday brain trying to function...",
                "Me remembering that thing I said 5 years ago.",
                "My wallet after the weekend:",
                "My serotonin levels right now.",
                "My will to live on a Monday.",
                "It's 8 AM. I'm already done.",
                "My brain cells after that meeting.",
                "Wait, it's already Friday?",
                "When someone says 'We need to talk'.",
                "My reaction to your opinion.",
                "I have several questions.",
                "Me pretending to listen.",
                "My bank account.",
                "My motivation.",
                "This week lasting 84 years.",
                "My main character energy today.",
                "My confidence vs. my skills.",
                "Me, an intellectual.",
                "My mental health.",
                "My brain on caffeine.",
                "My willpower avoiding snacks.",
                "My social battery right now.",
                "My productivity level.",
                "My last two brain cells.",
                "My patience running out.",
                "My soul leaving my body during small talk.",
                "My energy after one social interaction."
            ],
            relatable: [
                "When you finally understand the assignment.",
                "When the WiFi connects automatically.",
                "When you find money in your old jeans.",
                "When the teacher says 'no homework'.",
                "When you avoid someone you know in public.",
                "When you send a text and immediately regret it.",
                "When you're the last one to get the joke.",
                "When you try to be cool in front of your crush.",
                "When your parents are proud of you.",
                "When you remember embarrassing childhood memories.",
                "When you're home alone and hear a noise.",
                "When you successfully parallel park on first try.",
                "When you pretend to work when boss walks by.",
                "When you're watching a movie and recognize an actor.",
                "When you try to sneak food into the movie theater.",
                "When you're singing in the car and make eye contact.",
                "When you're trying to be quiet but everything is loud.",
                "When you see your ex looking better than you.",
                "When you're about to sneeze but it goes away.",
                "When you're telling a story and no one is listening."
            ],
            popCulture: [
                "That's what she said. - Michael Scott",
                "Why are you the way that you are? - Michael Scott",
                "I'm not superstitious, but I am a little stitious. - Michael Scott",
                "How the turntables... - Michael Scott",
                "You miss 100% of the shots you don't take. - Wayne Gretzky - Michael Scott",
                "I'm ready to get hurt again. - Michael Scott",
                "I'm not a hero. I'm a high-functioning sociopath. - Sherlock",
                "Winter is coming. - Game of Thrones",
                "You know nothing, Jon Snow. - Game of Thrones",
                "This is the way. - The Mandalorian",
                "I have a bad feeling about this. - Star Wars",
                "May the force be with you. - Star Wars"
            ],
            funny: [
                "This is fine. Everything is fine.",
                "Wait, that's illegal.",
                "Ah yes, the floor here is made of floor.",
                "They had us in the first half, not gonna lie.",
                "Is this a pigeon?",
                "I've never been so offended by something I 100% agree with.",
                "But that's none of my business.",
                "That's a bold strategy, Cotton. Let's see if it pays off.",
                "Cool story, bro.",
                "You had one job.",
                "I don't know what I expected.",
                "Well, well, well, how the turntables...",
                "I've made a huge mistake.",
                "There's always money in the banana stand.",
                "Her?",
                "It's an illusion, Michael.",
                "I don't understand the question, and I won't respond to it."
            ]
        };

        // Premium captions (now available to all users)
        const premiumCaptions = [
            "When you're the main character but forgot your lines",
            "My brain during small talk: 🎪🤹‍♂️🎭",
            "Me trying to adult: 🤡🌍",
            "My productivity: 📉📉📉",
            "My social skills: 🦔🎤",
            "My confidence: 🚀🌕 | My skills: 🐌🛌",
            "Me pretending to work: 🎭💼🤫",
            "My bank account: 🕳️👀🌀",
            "My mental health: 🎢🌪️🎭"
        ];
        
        // --- Expose variables to the window object for the TSX module ---
        window.userPhotoData = userPhotoData;
        window.selectedEmojis = selectedEmojis;
        
        // --- Consent Management ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        function checkConsent() {
            const consent = getCookie("user_consent");
            const banner = document.getElementById('cookieConsentBanner');
            
            if (consent === "true") {
                setupAdObserver(); // User has consented, prepare home ad.
            } else if (consent === "false") {
                // User has declined, do nothing.
            } else {
                banner.style.display = 'flex'; // No consent given yet, show banner.
            }

            document.getElementById('acceptCookies').addEventListener('click', () => {
                setCookie('user_consent', 'true', 365);
                banner.style.display = 'none';
                setupAdObserver();
            });

            document.getElementById('declineCookies').addEventListener('click', () => {
                setCookie('user_consent', 'false', 365);
                banner.style.display = 'none';
            });
        }

        // Initialize the app
        function initApp() {
            // Add premium emojis to the symbols category for all users
            emojiCategories.symbols = [...emojiCategories.symbols, ...premiumEmojis];
            
            populateEmojiTabs();
            showEmojiCategory('smileys');
            populateCaptionDropdown();
            populateFeaturedMemes();
            setupCaptionBackgrounds();
            updateAddEmojiButton();
            checkConsent(); // Check for consent before loading ads
            setupThemeToggle();
            setupSwipeGestures();
            setupGlobalDragListeners();
        }
        
        // --- Theme Toggle ---
        function setupThemeToggle() {
             // Set the toggle to the correct state on load
            if (document.body.classList.contains('dark-mode')) {
                themeToggle.checked = true;
            }

            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
        
        // --- AdSense Loading Functions ---
        function setupAdObserver() {
            const adContainer = document.getElementById('homeAdContainer');
            if (!adContainer) return;

            adObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadHomeAd();
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.01 });
            adObserver.observe(adContainer);
        }
        
        function robustAdLoad(container, slotId) {
            if (!container || container.querySelector('.adsbygoogle')) {
                return; // Abort if no container or ad already loaded
            }

            container.innerHTML = ''; // Clear any placeholders

            let attempts = 0;
            const maxAttempts = 40; // Try for 2 seconds total (40 * 50ms)

            function tryLoad() {
                if (container.offsetWidth > 0) {
                    const adSlot = document.createElement('ins');
                    adSlot.className = 'adsbygoogle';
                    adSlot.style.display = 'block';
                    adSlot.dataset.adClient = 'ca-pub-2629754813976130';
                    adSlot.dataset.adSlot = slotId;
                    adSlot.dataset.adFormat = 'auto';
                    adSlot.dataset.fullWidthResponsive = 'true';
                    
                    container.appendChild(adSlot);
                    
                    try {
                        (window.adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {
                        console.error("AdSense push error:", e);
                    }
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(tryLoad, 50);
                } else {
                    console.warn(`Ad container (${container.id}) did not get a valid width.`);
                }
            }
            tryLoad();
        }

        function loadHomeAd() {
            if (getCookie("user_consent") !== "true") return;
            const adContainer = document.getElementById('homeAdContainer');
            robustAdLoad(adContainer, '3919610151');
        }

        function loadEditorAd() {
            if (getCookie("user_consent") !== "true") return;
            const adContainer = document.getElementById('editorAdContainer');
            // It's recommended to create a separate ad unit in AdSense for this placement for better performance tracking.
            robustAdLoad(adContainer, '3919610151');
        }

        // Populate emoji tabs
        function populateEmojiTabs() {
            emojiTabs.innerHTML = '';
            
            for (const category in emojiCategories) {
                const tab = document.createElement('div');
                tab.className = 'emoji-tab';
                tab.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                tab.onclick = () => showEmojiCategory(category);
                emojiTabs.appendChild(tab);
            }
            
            if (emojiTabs.firstChild) {
                emojiTabs.firstChild.classList.add('active');
            }
        }

        // Show emojis for a specific category
        function showEmojiCategory(category) {
            const tabs = emojiTabs.getElementsByClassName('emoji-tab');
            for (const tab of tabs) {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(category)) {
                    tab.classList.add('active');
                }
            }
            
            emojiGrid.innerHTML = '';
            
            emojiCategories[category].forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji';
                emojiElement.textContent = emoji;
                emojiElement.onclick = () => addEmojiToSelection(emoji);
                emojiGrid.appendChild(emojiElement);
            });
            
            currentEmojiCategory = category;
        }

        // Add emoji to selection
        function addEmojiToSelection(emoji) {
            if (selectedEmojis.length >= 3) {
                alert('Maximum of 3 emojis reached. Remove one to add another.');
                return;
            }
            
            const container = document.querySelector('.meme-container');
            const containerWidth = container && container.offsetWidth > 0 ? container.offsetWidth : 450;
            const initialSize = Math.min(100, Math.max(50, containerWidth / 6));

            selectedEmojis.push({
                emoji: emoji,
                x: 30 + (selectedEmojis.length * 20),
                y: 30 + (selectedEmojis.length * 10),
                fontSize: initialSize
            });
            
            updateEmojiCounter();
            renderSelectedEmojisList();
            renderEmojiOverlays();
        }

        // Remove emoji from selection
        function removeEmojiFromSelection(index) {
            selectedEmojis.splice(index, 1);
            updateEmojiCounter();
            renderSelectedEmojisList();
            renderEmojiOverlays();
        }

        // Update emoji counter
        function updateEmojiCounter() {
            emojiCounter.textContent = `Selected: ${selectedEmojis.length}/3`;
            updateAddEmojiButton();
        }

        // Update the Add Emoji button text
        function updateAddEmojiButton() {
            if (addEmojiButton) {
                addEmojiButton.textContent = `Add Emojis (${selectedEmojis.length}/3)`;
            }
        }

        // Render selected emojis list
        function renderSelectedEmojisList() {
            selectedEmojisList.innerHTML = '';
            
            selectedEmojis.forEach((emojiObj, index) => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'selected-emoji';
                emojiElement.textContent = emojiObj.emoji;
                
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-emoji';
                removeButton.textContent = '×';
                removeButton.onclick = (e) => {
                    e.stopPropagation();
                    removeEmojiFromSelection(index);
                };
                
                emojiElement.appendChild(removeButton);
                selectedEmojisList.appendChild(emojiElement);
            });
        }

        // Populate caption dropdown
        function populateCaptionDropdown() {
            captionSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select or Write your Own caption...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            captionSelect.appendChild(defaultOption);
            
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Write my own caption...';
            captionSelect.appendChild(customOption);
            
            for (const category in memeCaptions) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = category.charAt(0).toUpperCase() + category.slice(1) + ' Captions';
                
                memeCaptions[category].forEach(caption => {
                    const option = document.createElement('option');
                    option.value = caption;
                    option.textContent = caption;
                    optGroup.appendChild(option);
                });
                
                captionSelect.appendChild(optGroup);
            }
            
            const premiumOptGroup = document.createElement('optgroup');
            premiumOptGroup.label = '⭐ Premium Captions';
            
            premiumCaptions.forEach(caption => {
                const option = document.createElement('option');
                option.value = caption;
                option.textContent = caption;
                premiumOptGroup.appendChild(option);
            });
            
            captionSelect.appendChild(premiumOptGroup);
        }

        // Setup caption background swatches
        function setupCaptionBackgrounds() {
            const backgrounds = [
                { id: 'none', style: 'transparent', title: 'None', text: 'Aa' },
                { id: 'black-bar', style: 'rgba(0,0,0,0.6)', title: 'Black Bar' },
                { id: 'white-bar', style: 'rgba(255,255,255,0.7)', title: 'White Bar' },
                { id: 'black-solid', style: 'black', title: 'Solid Black' },
                { id: 'white-solid', style: 'white', title: 'Solid White' }
            ];

            captionBgSwatches.innerHTML = '';

            backgrounds.forEach(bg => {
                const swatch = document.createElement('div');
                swatch.className = 'caption-bg-swatch';
                swatch.dataset.bg = bg.id;
                swatch.style.background = bg.style;
                swatch.title = bg.title;

                if (bg.text) {
                    swatch.textContent = bg.text;
                    swatch.style.borderColor = '#ccc';
                    swatch.style.color = 'var(--text-color)';
                }
                 if (bg.id === 'white-solid') {
                    swatch.style.borderColor = '#ccc';
                }

                if (bg.id === selectedCaptionBackground) {
                    swatch.classList.add('selected');
                }

                swatch.addEventListener('click', () => {
                    document.querySelectorAll('.caption-bg-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                    selectedCaptionBackground = bg.id;
                });

                captionBgSwatches.appendChild(swatch);
            });
        }

        // Handle caption change
        function handleCaptionChange() {
            const selectedValue = captionSelect.value;
            
            if (selectedValue === 'custom') {
                customCaption.style.display = 'block';
                customCaption.value = '';
                selectedCaption = '';
            } else {
                customCaption.style.display = 'none';
                selectedCaption = selectedValue;
            }
        }
        
        // Handle font change
        function handleFontChange() {
            selectedFont = fontSelect.value;
        }

        // Populate featured memes on home screen
        function populateFeaturedMemes() {
            const samples = [
                { caption: "My Monday mood", emoji: "😴" },
                { caption: "When the code works", emoji: "🎉" },
                { caption: "My social battery", emoji: "🔋" },
                { caption: "My brain on caffeine", emoji: "⚡" }
            ];
            
            samples.forEach(sample => {
                const memeElement = document.createElement('div');
                memeElement.className = 'meme-sample';
                
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = '20px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(sample.caption, canvas.width / 2, 50);
                
                ctx.font = '80px Arial';
                ctx.fillText(sample.emoji, canvas.width / 2, canvas.height / 2);
                
                const dataUrl = canvas.toDataURL('image/png');
                
                memeElement.innerHTML = `
                    <img src="${dataUrl}" alt="${sample.caption}">
                    <p>${sample.caption}</p>
                `;
                
                memeElement.onclick = () => {
                    selectedEmojis = [{ emoji: sample.emoji, x: 50, y: 30, fontSize: 80 }];
                    uploadPhoto();
                };
                
                featuredMemes.appendChild(memeElement);
            });
        }

        // --- View Management ---

        function showHome() {
            homeView.style.display = 'block';
            cameraView.style.display = 'none';
            editorView.style.display = 'none';
            previewView.style.display = 'none';
            emojiSelectionView.style.display = 'none';
            
            if (cameraVideo.srcObject) {
                cameraVideo.srcObject.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
            }
            
            if (getCookie("user_consent") === "true") {
                const adContainer = document.getElementById('homeAdContainer');
                if (adObserver && adContainer) {
                    adContainer.innerHTML = '';
                    adObserver.observe(adContainer);
                }
            }
        }

        function showCamera() {
            homeView.style.display = 'none';
            cameraView.style.display = 'block';
            captureBtn.disabled = true;
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
            .then(stream => {
                cameraVideo.srcObject = stream;
                cameraVideo.oncanplay = () => {
                   captureBtn.disabled = false;
                };
            })
            .catch(error => {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please check permissions.');
                showHome();
            });
        }

        // Show editor view when swiping back from preview
        function showEditor() {
            previewView.style.display = 'none';
            editorView.style.display = 'block';
        }

        // Upload photo from gallery
        function uploadPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        const img = new Image();
                        img.onload = function() {
                            const maxWidth = 800;
                            const maxHeight = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round(height * maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round(width * maxHeight / height);
                                    height = maxHeight;
                                }
                            }
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            userPhotoData = canvas.toDataURL('image/jpeg', 0.8);
                            window.userPhotoData = userPhotoData;
                            photoPreview.src = userPhotoData;
                            
                            homeView.style.display = 'none';
                            editorView.style.display = 'block';
                            loadEditorAd();
                            
                            editorContainerWidth = memeContainer.offsetWidth;
                            renderEmojiOverlays();
                            setTimeout(adjustEditorControlSizes, 100);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Adjust caption input sizes based on container
        function adjustEditorControlSizes() {
            const container = document.querySelector('.meme-container');
            if (!container) return;
            const containerWidth = container.offsetWidth;
            const captionSize = Math.min(20, Math.max(14, containerWidth / 25));
            document.querySelectorAll('.caption-select, .custom-caption, .font-select').forEach(el => {
                el.style.fontSize = `${captionSize}px`;
            });
        }

        // Render emoji overlays
        function renderEmojiOverlays() {
            document.querySelectorAll('.memoji-overlay').forEach(el => el.remove());
            selectedEmojis.forEach((emojiObj, index) => {
                const overlay = document.createElement('div');
                overlay.className = 'memoji-overlay';
                overlay.textContent = emojiObj.emoji;
                overlay.style.left = `${emojiObj.x}%`;
                overlay.style.top = `${emojiObj.y}%`;
                overlay.style.transform = 'translate(-50%, -50%)';
                overlay.style.fontSize = `${emojiObj.fontSize}px`;
                
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                
                makeDraggable(overlay, index);
                makeResizable(overlay, resizeHandle, index);
                
                overlay.appendChild(resizeHandle);
                memeContainer.appendChild(overlay);
            });
        }

        // --- Centralized Drag/Resize/Pinch Event Handling ---
        
        function setupGlobalDragListeners() {
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleUp);
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleUp);

            function handleMove(e) {
                if ((!isDragging && !isResizing) || activeEmojiIndex === -1) return;
                if (e.touches && e.touches.length > 1) return; // Let local pinch handler take over
                if (e.cancelable) e.preventDefault();

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const activeOverlay = document.querySelectorAll('.memoji-overlay')[activeEmojiIndex];
                if (!activeOverlay) return;

                if (isDragging) {
                    const containerRect = memeContainer.getBoundingClientRect();
                    let centerX = clientX - containerRect.left - dragOffset.x;
                    let centerY = clientY - containerRect.top - dragOffset.y;
                    
                    const percentX = (centerX / containerRect.width) * 100;
                    const percentY = (centerY / containerRect.height) * 100;
                    
                    const emojiWidthPercent = (activeOverlay.offsetWidth / containerRect.width) * 100;
                    const emojiHeightPercent = (activeOverlay.offsetHeight / containerRect.height) * 100;
                    
                    const boundedX = Math.max(emojiWidthPercent/2, Math.min(percentX, 100 - emojiWidthPercent/2));
                    const boundedY = Math.max(emojiHeightPercent/2, Math.min(percentY, 100 - emojiHeightPercent/2));
                    
                    activeOverlay.style.left = `${boundedX}%`;
                    activeOverlay.style.top = `${boundedY}%`;
                    
                    selectedEmojis[activeEmojiIndex].x = boundedX;
                    selectedEmojis[activeEmojiIndex].y = boundedY;
                } else if (isResizing) {
                    const deltaX = clientX - resizeStart.x;
                    const deltaY = clientY - resizeStart.y;
                    const delta = Math.sqrt(deltaX * deltaX + deltaY * deltaY) * (deltaX + deltaY > 0 ? 1 : -1);
                    const newSize = Math.max(20, Math.min(200, resizeStart.size + delta));
                    
                    activeOverlay.style.fontSize = `${newSize}px`;
                    selectedEmojis[activeEmojiIndex].fontSize = newSize;
                }
            }

            function handleUp() {
                if (isDragging && activeEmojiIndex !== -1) {
                    const activeOverlay = document.querySelectorAll('.memoji-overlay')[activeEmojiIndex];
                    if (activeOverlay) activeOverlay.style.cursor = 'grab';
                }
                isDragging = false;
                isResizing = false;
                activeEmojiIndex = -1;
            }
        }

        // Make emoji draggable and handle pinch-to-zoom
        function makeDraggable(element, index) {
            let initialPinchDistance = 0;
            let initialFontSize = 0;

            function handleMouseDown(e) {
                if (isResizing || (e.target && e.target.classList.contains('resize-handle'))) return;
                
                isDragging = true;
                activeEmojiIndex = index;
                const rect = element.getBoundingClientRect();
                dragOffset.x = e.clientX - (rect.left + rect.width / 2);
                dragOffset.y = e.clientY - (rect.top + rect.height / 2);
                element.style.cursor = 'grabbing';
            }

            function handleTouchStart(e) {
                if (isResizing || (e.target && e.target.classList.contains('resize-handle'))) return;

                if (e.touches.length === 2) {
                    isDragging = false; // Prevent single-touch drag from interfering
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialPinchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialFontSize = parseInt(getComputedStyle(element).fontSize);
                    e.preventDefault();
                } else if (e.touches.length === 1) {
                    isDragging = true;
                    activeEmojiIndex = index;
                    const rect = element.getBoundingClientRect();
                    const clientX = e.touches[0].clientX;
                    const clientY = e.touches[0].clientY;
                    dragOffset.x = clientX - (rect.left + rect.width / 2);
                    dragOffset.y = clientY - (rect.top + rect.height / 2);
                    element.style.cursor = 'grabbing';
                }
            }

            element.addEventListener('mousedown', handleMouseDown);
            element.addEventListener('touchstart', handleTouchStart, { passive: false });

            // This listener handles the pinch-zoom logic locally on the element
            element.addEventListener('touchmove', e => {
                if (isResizing || e.touches.length !== 2) return;
                
                e.preventDefault(); // Prevent page zoom
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentPinchDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                const scale = currentPinchDistance / initialPinchDistance;
                const newSize = Math.max(20, Math.min(200, initialFontSize * scale));
                
                element.style.fontSize = `${newSize}px`;
                selectedEmojis[index].fontSize = newSize;
            });
        }
        
        // Make emoji resizable
        function makeResizable(element, handle, index) {
            function handleDown(e) {
                e.stopPropagation();
                
                isResizing = true;
                activeEmojiIndex = index;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                resizeStart.size = parseInt(getComputedStyle(element).fontSize);
                resizeStart.x = clientX;
                resizeStart.y = clientY;
            }

            handle.addEventListener('mousedown', handleDown);
            handle.addEventListener('touchstart', handleDown, { passive: false });
        }


        // Capture photo from camera
        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            userPhotoData = canvas.toDataURL('image/png');
            window.userPhotoData = userPhotoData;
            photoPreview.src = userPhotoData;
            
            if (cameraVideo.srcObject) {
                cameraVideo.srcObject.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
            }
            
            cameraView.style.display = 'none';
            editorView.style.display = 'block';
            loadEditorAd();
            
            editorContainerWidth = memeContainer.offsetWidth;
            renderEmojiOverlays();
            setTimeout(adjustEditorControlSizes, 100);
        }

        // Show emoji selection view
        function showEmojiSelection() {
            editorView.style.display = 'none';
            emojiSelectionView.style.display = 'block';
            updateEmojiCounter();
        }

        // Confirm emoji selection and return to editor
        function confirmEmojiSelection() {
            emojiSelectionView.style.display = 'none';
            editorView.style.display = 'block';
            renderEmojiOverlays();
        }

        // Cancel emoji selection
        function cancelEmojiSelection() {
            emojiSelectionView.style.display = 'none';
            editorView.style.display = 'block';
        }

        // --- Swipe Gesture Logic ---

        function setupSwipeGestures() {
            const container = document.querySelector('.container');
            container.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                handleGesture();
            }, { passive: true });
        }

        function handleGesture() {
            const horizontalMove = touchstartX - touchendX;
            const verticalMove = touchstartY - touchendY;

            // Ignore if vertical scroll is more significant or if it's not a real swipe
            if (Math.abs(horizontalMove) < Math.abs(verticalMove) || Math.abs(horizontalMove) < swipeThreshold) {
                return;
            }

            // Prevent swipe when an emoji interaction is active
            if (isDragging || isResizing) {
                return;
            }

            const swipedLeft = horizontalMove > 0;
            const swipedRight = horizontalMove < 0;

            // Check which view is active to determine action
            if (cameraView.style.display === 'block') {
                if (swipedRight) showHome();
            } else if (editorView.style.display === 'block') {
                if (swipedLeft) generateMeme();
                else if (swipedRight) startOver(); // Use startOver to reset state
            } else if (previewView.style.display === 'block') {
                if (swipedRight) showEditor();
            }
        }

        // --- Meme Generation and Sharing ---

        function generateMeme() {
            if (captionSelect.value === 'custom') {
                selectedCaption = customCaption.value.trim();
            } else {
                selectedCaption = captionSelect.value;
            }
            
            if (!selectedCaption) {
                selectedCaption = "Mood Mirror Meme";
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                const width = img.naturalWidth;
                const height = img.naturalHeight;
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const boxWidth = photoPreview.offsetWidth;
                const boxHeight = photoPreview.offsetHeight;
                const naturalAspectRatio = width / height;
                const boxAspectRatio = boxWidth / boxHeight;

                let renderedImageWidth, renderedImageHeight, offsetX, offsetY;

                if (naturalAspectRatio > boxAspectRatio) {
                    renderedImageWidth = boxWidth;
                    renderedImageHeight = renderedImageWidth / naturalAspectRatio;
                    offsetX = 0;
                    offsetY = (boxHeight - renderedImageHeight) / 2;
                } else {
                    renderedImageHeight = boxHeight;
                    renderedImageWidth = renderedImageHeight * naturalAspectRatio;
                    offsetY = 0;
                    offsetX = (boxWidth - renderedImageWidth) / 2;
                }
                
                const scale = width / renderedImageWidth;
                
                selectedEmojis.forEach(emojiObj => {
                    const pixelX_in_box = (emojiObj.x / 100) * boxWidth;
                    const pixelY_in_box = (emojiObj.y / 100) * boxHeight;
                    const pixelX_on_image = pixelX_in_box - offsetX;
                    const pixelY_on_image = pixelY_in_box - offsetY;
                    const finalPercentX = (pixelX_on_image / renderedImageWidth) * 100;
                    const finalPercentY = (pixelY_on_image / renderedImageHeight) * 100;
                    const x = (finalPercentX / 100) * width;
                    const y = (finalPercentY / 100) * height;
                    const scaledEmojiSize = emojiObj.fontSize * scale;
                    
                    ctx.font = `bold ${scaledEmojiSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(emojiObj.emoji, x, y);
                });
                
                const captionFontSize = Math.max(24, Math.min(48, width / 20));
                ctx.font = `bold ${captionFontSize}px ${selectedFont}`;
                ctx.textAlign = 'center';
                
                const maxTextWidth = width * 0.9;
                const words = selectedCaption.split(' ');
                const lines = [];
                let currentLine = words[0] || '';
                let maxLineWidth = 0;

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const widthWithWord = ctx.measureText(currentLine + " " + word).width;
                    if (widthWithWord < maxTextWidth) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        maxLineWidth = Math.max(maxLineWidth, ctx.measureText(currentLine).width);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                maxLineWidth = Math.max(maxLineWidth, ctx.measureText(currentLine).width);
                
                const lineHeight = captionFontSize * 1.2;
                const bottomMargin = height * 0.05;
                let textY = height - bottomMargin - ( (lines.length -1) * lineHeight );

                // Draw caption background
                let textColor = 'white';
                let strokeColor = 'black';
                const textPadding = captionFontSize / 4;
                const totalTextHeight = (lines.length * lineHeight) - (lineHeight - captionFontSize);
                const bgY = textY - (captionFontSize * 0.8) - textPadding;
                const bgHeight = totalTextHeight + (textPadding * 2);
                
                switch (selectedCaptionBackground) {
                    case 'black-bar':
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                        ctx.fillRect(0, bgY, width, bgHeight);
                        break;
                    case 'white-bar':
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        ctx.fillRect(0, bgY, width, bgHeight);
                        textColor = 'black';
                        strokeColor = 'rgba(255, 255, 255, 0.8)';
                        break;
                    case 'black-solid':
                        ctx.fillStyle = 'black';
                        const bgX_b = (width - maxLineWidth) / 2 - textPadding;
                        const bgWidth_b = maxLineWidth + (textPadding * 2);
                        ctx.fillRect(bgX_b, bgY, bgWidth_b, bgHeight);
                        break;
                    case 'white-solid':
                        ctx.fillStyle = 'white';
                        const bgX_w = (width - maxLineWidth) / 2 - textPadding;
                        const bgWidth_w = maxLineWidth + (textPadding * 2);
                        ctx.fillRect(bgX_w, bgY, bgWidth_w, bgHeight);
                        textColor = 'black';
                        strokeColor = 'rgba(0,0,0,0.2)';
                        break;
                }

                // Draw caption text
                ctx.fillStyle = textColor;
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = Math.max(3, captionFontSize / 8);
                
                lines.forEach((line, index) => {
                    const y = textY + (index * lineHeight);
                    ctx.strokeText(line, width / 2, y);
                    ctx.fillText(line, width / 2, y);
                });
                
                finalMemeDataURL = canvas.toDataURL('image/png');
                finalMeme.src = finalMemeDataURL;
                
                editorView.style.display = 'none';
                previewView.style.display = 'block';
            };
            
            img.src = userPhotoData;
        }

        function downloadMeme() {
            const link = document.createElement('a');
            link.download = 'mood-mirror-meme.png';
            link.href = finalMemeDataURL || finalMeme.src;
            link.click();
        }

        function shareMeme(platform) {
            shareFeedback.style.display = 'none';
            if (navigator.share && navigator.canShare) {
                try {
                    fetch(finalMemeDataURL)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], 'mood-mirror-meme.png', { type: 'image/png' });
                            const shareData = {
                                title: 'My Mood Mirror Meme',
                                text: 'Check out this meme I made with Mood Mirror!',
                                files: [file],
                            };
                            
                            if (navigator.canShare(shareData)) {
                                navigator.share(shareData)
                                    .then(() => {
                                        showShareFeedback('Meme shared successfully!', true);
                                    })
                                    .catch(error => {
                                        if (error.name !== 'AbortError') {
                                           console.error('Error sharing:', error);
                                           fallbackShare(platform);
                                        }
                                    });
                            } else {
                                fallbackShare(platform);
                            }
                        })
                        .catch(error => {
                            console.error('Error converting image:', error);
                            fallbackShare(platform);
                        });
                } catch (error) {
                    console.error('Error preparing share:', error);
                    fallbackShare(platform);
                }
            } else {
                fallbackShare(platform);
            }
        }

        function fallbackShare(platform) {
            const shareUrl = window.location.href;
            const shareText = 'Check out this meme I made with Mood Mirror!';
            let shareWindowUrl;
            
            switch(platform) {
                case 'facebook':
                    shareWindowUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'twitter':
                    shareWindowUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'whatsapp':
                    shareWindowUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                    break;
                case 'tiktok':
                    window.open(shareUrl, '_blank');
                    showShareFeedback('Please download the meme and share it directly on TikTok', false);
                    return;
                default:
                    console.error('Unknown platform:', platform);
                    return;
            }
            window.open(shareWindowUrl, '_blank');
            showShareFeedback(`Shared to ${platform}! To share the image, use the native share on your device.`, true);
        }

        function showShareFeedback(message, isSuccess) {
            shareFeedback.textContent = message;
            shareFeedback.className = `share-feedback ${isSuccess ? 'share-success' : 'share-error'}`;
            shareFeedback.style.display = 'block';
            setTimeout(() => {
                shareFeedback.style.display = 'none';
            }, 5000);
        }

        function shareApp(platform) {
            const shareUrl = window.location.href;
            const shareText = 'Check out Mood Mirror - a free tool to create hilarious memes with your photos and emojis!';
            let shareWindowUrl;
            
            switch(platform) {
                case 'facebook':
                    shareWindowUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'twitter':
                    shareWindowUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'whatsapp':
                    shareWindowUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                    break;
                default:
                    console.error('Unknown platform:', platform);
                    return;
            }
            window.open(shareWindowUrl, '_blank');
        }

        // Resets all state variables and UI elements to their initial state.
        function resetState() {
            selectedEmojis.length = 0; // Clear the array
            userPhotoData = null;
            window.userPhotoData = null;
            selectedCaption = '';
            selectedCaptionBackground = 'none';
            finalMemeDataURL = null;

            // Reset UI form elements to their default state
            if (captionSelect) captionSelect.value = '';
            if (fontSelect) {
                fontSelect.value = 'Courier New';
                selectedFont = 'Courier New';
            }
             if (captionBgSwatches) {
                document.querySelectorAll('.caption-bg-swatch').forEach(s => s.classList.remove('selected'));
                captionBgSwatches.querySelector('[data-bg="none"]').classList.add('selected');
            }
            if (customCaption) {
                customCaption.value = '';
                customCaption.style.display = 'none';
            }
            if (photoPreview) photoPreview.src = '';
            
            // Clear any dynamically added emoji overlays from the editor view
            document.querySelectorAll('.memoji-overlay').forEach(el => el.remove());
            
            // Update UI counters and lists
            if (selectedEmojisList) selectedEmojisList.innerHTML = '';
            updateEmojiCounter(); // This also updates the button text
        }

        function startOver() {
            resetState();
            showHome();
        }

        window.onload = initApp;
    </script>
    <footer style="margin-top: 60px; text-align: center; color: #666; font-size: 14px; padding: 20px; border-top: 1px solid var(--input-border-color);">
    <a href="/privacy-policy.html" style="margin: 0 10px; color: var(--secondary);">Privacy Policy</a> |
    <a href="/terms-of-service.html" style="margin: 0 10px; color: var(--secondary);">Terms of Service</a> |
    <a href="/contact.html" style="margin: 0 10px; color: var(--secondary);">Contact</a> |
    <a href="/about.html" style="margin: 0 10px; color: var(--secondary);">About Us</a>
    <p>&copy; 2025 Mood Mirror. All rights reserved.</p>
</footer>
<script type="module" src="/index.tsx"></script>
</body>
</html>